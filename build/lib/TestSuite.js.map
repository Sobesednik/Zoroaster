{"version":3,"sources":["../../src/lib/TestSuite.js"],"names":[],"mappings":"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","file":"lib/TestSuite.js","sourcesContent":["import { EOL } from 'os'\nimport { isFunction, checkTestSuiteName, runInSequence, indent } from '.'\nimport Test from './Test'\n\nconst TIMEOUT = parseInt(process.env.ZOROASTER_TIMEOUT, 10) || 2000\n\nfunction hasParent({ parent }) {\n  return parent instanceof TestSuite\n}\n\n/**\n * A test suite is a collection of tests with any number of contexts.\n */\nexport default class TestSuite {\n  constructor (name, testsOrPath, parent, context, timeout) {\n    checkTestSuiteName(name)\n\n    this._name = name\n    this._parent = parent\n    this._timeout = timeout || (hasParent(this) ? this.parent.timeout : undefined)\n\n    if (!this._assignContext(context) && hasParent(this)) {\n      this._context = parent.context\n    }\n\n    if (typeof testsOrPath == 'string') {\n      this._path = testsOrPath\n    } else if (typeof testsOrPath == 'object') {\n      this._assignTests(testsOrPath)\n    } else {\n      throw new Error('You must provide either a path to a module, or tests in an object.')\n    }\n  }\n  get path() {\n    return this._path\n  }\n  get name() {\n    return this._name\n  }\n  get parent() {\n    return this._parent\n  }\n  get rawTests() {\n    return this._rawTests\n  }\n  /**\n   * @type {Test[]|TestSuite[]}\n   */\n  get tests() {\n    return this._tests\n  }\n  get context() {\n    return this._context\n  }\n  get timeout() {\n    return this._timeout\n  }\n\n  _assignContext(context) {\n    if (Array.isArray(context)) {\n      this._context = context\n      return true\n    }\n    const fn = isFunction(context)\n    if (fn) {\n      this._context = context\n      return true\n    }\n    if ((typeof context).toLowerCase() == 'object') {\n      const extendedContext = {\n        ...(this._context || {}),\n        ...context,\n      } // this is for when test suites are extending object contexts\n      this._context = Object.freeze(extendedContext)\n      return true\n    }\n  }\n\n  _assignTests(tests) {\n    if ('context' in tests) {\n      this._assignContext(tests.context)\n    }\n    this._rawTests = tests\n    this._tests = createTests(tests, this)\n  }\n\n  /**\n   * Recursively require files for a test suite.\n   * @todo require for a single test\n   */\n  require() {\n    if (this._path) {\n      const tests = requireModule(this._path)\n      this._assignTests(tests)\n    }\n    this.tests.forEach((test) => {\n      if (test instanceof TestSuite) {\n        test.require()\n      }\n    })\n  }\n\n  /**\n   * Run test suite.\n   */\n  async run(notify = () => {}) {\n    notify({\n      type:'test-suite-start',\n      name: this.name,\n    })\n    const res = await runInSequence(this.tests, notify)\n    notify({ type:'test-suite-end', name: this.name })\n    return res\n  }\n  dump() {\n    const str = this.name + EOL + this.tests\n      .map(test => test.dump())\n      .join('\\n')\n    return this.parent ? indent(str, '    ') : str\n  }\n  hasErrors() {\n    return this.tests\n      .find(test =>\n        test.hasErrors()\n      )\n  }\n}\n\nconst sortTestSuites = ({ name: a }, { name: b }) => {\n  if (a == 'default') return -1\n  if (b == 'default') return 1\n  return 0\n}\n\n/**\n * Sort tests and test suites so that tests run before\n * test suites. We delibarately don't use V8's unstable\n * Array.sort().\n * @param {Array} tests - test cases and test suites to sort\n * @returns {Array} Sorted array with tests before test suites.\n */\nfunction sort(tests) {\n  const testSuites = []\n  const testCases = []\n  tests.forEach((test) => {\n    if (test instanceof Test) {\n      testCases.push(test)\n    } else {\n      testSuites.push(test)\n    }\n  })\n  const sts = testSuites.sort(sortTestSuites)\n  return [...testCases, ...sts]\n}\n\nfunction filterContextKey(key) {\n  return key != 'context'\n}\n\n/**\n * Map object with test names as keys and test functions as values\n * to an array of tests.\n * @param {object} object - a raw tests map as found in test files\n * @param {TestSuite} parent - parent test suite\n * @return {Array<Test>} An array with tests.\n */\nfunction createTests(object, parent) {\n  const tests = Object\n    .keys(object)\n    .filter(filterContextKey)\n    .map((key) => {\n      const v = object[key]\n      switch (typeof v) {\n      case 'function': {\n        const test = new Test(key, v, parent.timeout || TIMEOUT, parent.context)\n        return test\n      }\n      case 'object': {\n        const ts = new TestSuite(key, v, parent)\n        return ts\n      }\n      case 'string': {\n        const ts = new TestSuite(key, v, parent)\n        return ts\n      }\n      }\n    })\n    .filter(test => test !== undefined)\n  return sort(tests)\n}\n\nfunction requireModule(modulePath) {\n  return require(modulePath)\n}\n"]}