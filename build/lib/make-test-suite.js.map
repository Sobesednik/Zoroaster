{"version":3,"sources":["../../src/lib/make-test-suite.js"],"names":[],"mappings":"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","file":"lib/make-test-suite.js","sourcesContent":["import erte from 'erte'\nimport { readdirSync, lstatSync } from 'fs'\nimport { resolve, join } from 'path'\nimport getTests from '../lib/mask'\nimport { equal, throws } from '../assert'\n\n/**\n * Make a test suite to test against a mask.\n * @param {string} path Path to the mask file or directory of files.\n * @param {MakeTestSuiteConf} [conf] Configuration for making test suites.\n * @param {({new(): Context}|{new(): Context}[]|{})} [conf.context] Single or multiple context constructors or objects to initialise for each test.\n * @param {(input: string, ...contexts?: Context[]) => string} [conf.getResults] A function which should return results of a test.\n * @param {(input: string, ...contexts?: Context[]) => { fn: function, args?: any[], message?: (string|RegExp) }} [conf.getThrowsConfig] A function which should return a configuration for [`assert-throws`](https://github.com/artdecocode/assert-throws), including `fn` and `args`, when testing an error.\n * @param {(results: any) => string} [conf.mapActual] An optional function to get a value to test against `expected` mask property from results. By default, the full result is used.\n * @param {(results: any, props: Object.<string, (string|object)>) => void} [conf.assertResults] A function containing any addition assertions on the results. The results from `getResults` and a map of expected values extracted from the mask (where `jsonProps` are parsed into JS objects) will be passed as arguments.\n * @param {string[]} [conf.jsonProps] Any additional properties to extract from the mask, and parse as _JSON_ values.\n * @param {RegExp} [conf.splitRe=\"/^\\/\\/ /gm\"] A regular expression used to detect the beginning of a new test in a mask file. Default `/^\\/\\/ /gm`.\n */\nexport default function makeTestSuite(path, conf) {\n  const pathStat = lstatSync(path)\n  if (pathStat.isFile()) {\n    return makeATestSuite(path, conf)\n  } else if (pathStat.isDirectory()) {\n    const content = readdirSync(path)\n    const res = content.reduce((acc, node) => {\n      const newPath = join(path, node)\n      return {\n        ...acc,\n        [node]: makeTestSuite(newPath, conf),\n      }\n    }, {})\n    return res\n  }\n}\n\n// The `expected` property of the mask will be compared against the actual value returned by the `getActual` function. To test for the correct error message, the `error` property will be tested using `assert-throws` configuration returned by `getThrowsConfig` function. Any additional tests can be performed with `customTest` function, which will receive any additional properties extracted from the mask using `customProps` and `jsonProps`. The JSON properties will be parsed into an object.\n\nconst makeATestSuite = (maskPath, conf) => {\n  if (!conf) throw new Error('No configuration is given. A config should at least contain either a \"getThrowsConfig\" or \"getResults\" functions.')\n  const {\n    context,\n    getResults,\n    getThrowsConfig,\n    mapActual = a => a,\n    assertResults,\n    jsonProps = [],\n    splitRe,\n  } = conf\n  const tests = getTests({ path: maskPath, splitRe })\n\n  const hasFocused = tests.some(({ name }) => name.startsWith('!'))\n\n  const t = tests.reduce((acc, {\n    name, input, expected, error, onError, ...rest\n  }) => {\n    if (hasFocused && !name.startsWith('!')) return acc\n    const nameError = name in acc ?\n      new Error(`Repeated use of the test name \"${name}\".`) : null\n\n    const fn = async (...contexts) => {\n      if (nameError) throw nameError\n\n      if (error) {\n        if (!getThrowsConfig)\n          throw new Error('No \"getThrowsConfig\" function is given.')\n        const throwsConfig = getThrowsConfig(input, ...contexts)\n        await assertError(throwsConfig, error)\n        return\n      }\n\n      if (!getResults) return\n\n      const parsedRest = Object.keys(rest).reduce((ac, k) => {\n        try {\n          const val = jsonProps.includes(k) ? JSON.parse(rest[k]) : rest[k]\n          ac[k] = val\n          return ac\n        } catch (err) {\n          throw new Error(`Could not parse JSON property \"${k}\": ${err.message}.`)\n        }\n      }, {})\n\n      const results = await getResults(input, ...contexts)\n\n      if (expected) {\n        const actual = mapActual(results)\n        if ((typeof actual).toLowerCase() != 'string')\n          throw new Error('The actual result is not an a string. Use \"mapActual\" function to map to a string result.')\n        assertExpected(actual, expected)\n      }\n      if (assertResults) {\n        assertResults(results, parsedRest)\n      }\n    }\n    acc[name] = async (...args) => {\n      try {\n        await fn(...args)\n      } catch (err) {\n        onError(err)\n      }\n    }\n    return acc\n  }, context ? { context } : {})\n  return t\n}\n\nconst assertError = async (throwsConfig, error) => {\n  await throws({\n    ...throwsConfig,\n    message: error,\n  })\n}\n\nconst assertExpected = (result, expected) => {\n  if (!expected) return\n  try {\n    equal(result, expected)\n  } catch (err) {\n    const e = erte(result, expected)\n    console.log(e) // eslint-disable-line no-console\n    throw err\n  }\n}\n\n/* documentary types/make-test-suite.xml */\n/**\n * @typedef {Object} Context A context made with a constructor.\n * @prop {() => void} [_init] A function to initialise the context.\n * @prop {() => void} [_destroy] A function to destroy the context.\n *\n * @typedef {Object} MakeTestSuiteConf Configuration for making test suites.\n * @prop {({new(): Context}|{new(): Context}[]|{})} [context] Single or multiple context constructors or objects to initialise for each test.\n * @prop {(input: string, ...contexts?: Context[]) => string} [getResults] A function which should return results of a test.\n * @prop {(input: string, ...contexts?: Context[]) => { fn: function, args?: any[], message?: (string|RegExp) }} [getThrowsConfig] A function which should return a configuration for [`assert-throws`](https://github.com/artdecocode/assert-throws), including `fn` and `args`, when testing an error.\n * @prop {(results: any) => string} [mapActual] An optional function to get a value to test against `expected` mask property from results. By default, the full result is used.\n * @prop {(results: any, props: Object.<string, (string|object)>) => void} [assertResults] A function containing any addition assertions on the results. The results from `getResults` and a map of expected values extracted from the mask (where `jsonProps` are parsed into JS objects) will be passed as arguments.\n * @prop {string[]} [jsonProps] Any additional properties to extract from the mask, and parse as _JSON_ values.\n * @prop {RegExp} [splitRe=\"/^\\/\\/ /gm\"] A regular expression used to detect the beginning of a new test in a mask file. Default `/^\\/\\/ /gm`.\n */\n\n// export default makeTestSuite"]}